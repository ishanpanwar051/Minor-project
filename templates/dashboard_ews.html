{% extends "layout_ews.html" %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600">Welcome back, {{ current_user.first_name }}! Here's your overview.</p>
        </div>
        <div class="flex gap-3">
            <button class="btn btn-primary" onclick="exportReport()">
                <i class="fas fa-download mr-2"></i>
                Export Report
            </button>
            <button class="btn btn-secondary" onclick="refreshData()">
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="dashboard-grid mb-8">
        <!-- Total Students -->
        <div class="stat-card">
            <div class="flex justify-between items-start">
                <div>
                    <p class="stat-label">Total Students</p>
                    <p class="stat-value">{{ total_students }}</p>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up text-xs"></i>
                        <span>+12% from last month</span>
                    </div>
                </div>
                <div class="text-3xl text-blue-500">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>

        <!-- At Risk Students -->
        <div class="stat-card danger">
            <div class="flex justify-between items-start">
                <div>
                    <p class="stat-label">At Risk Students</p>
                    <p class="stat-value">{{ at_risk_students }}</p>
                    <div class="stat-change negative">
                        <i class="fas fa-arrow-up text-xs"></i>
                        <span>+5% from last week</span>
                    </div>
                </div>
                <div class="text-3xl text-red-500">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="stat-card warning">
            <div class="flex justify-between items-start">
                <div>
                    <p class="stat-label">Active Alerts</p>
                    <p class="stat-value">{{ active_alerts }}</p>
                    <div class="stat-change">
                        <i class="fas fa-minus text-xs"></i>
                        <span>Same as yesterday</span>
                    </div>
                </div>
                <div class="text-3xl text-yellow-500">
                    <i class="fas fa-bell"></i>
                </div>
            </div>
        </div>

        <!-- Interventions -->
        <div class="stat-card success">
            <div class="flex justify-between items-start">
                <div>
                    <p class="stat-label">This Month's Interventions</p>
                    <p class="stat-value">{{ monthly_interventions }}</p>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up text-xs"></i>
                        <span>+8% from last month</span>
                    </div>
                </div>
                <div class="text-3xl text-green-500">
                    <i class="fas fa-hands-helping"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Risk Distribution Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Risk Distribution</h3>
                <div class="chart-options">
                    <select class="form-control form-select text-sm" id="riskTimeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 3 months</option>
                    </select>
                </div>
            </div>
            <canvas id="riskChart" width="400" height="200"></canvas>
        </div>

        <!-- Attendance Trend Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Attendance Trend</h3>
                <div class="chart-options">
                    <select class="form-control form-select text-sm" id="attendanceTimeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 3 months</option>
                    </select>
                </div>
            </div>
            <canvas id="attendanceChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Recent Alerts Table -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="card-title">Recent Alerts</h3>
            <a href="{{ url_for('main.alerts') }}" class="btn btn-outline btn-sm">
                View All Alerts
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Type</th>
                        <th>Risk Level</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in recent_alerts %}
                    <tr>
                        <td>
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-blue-600 text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ alert.student_name }}</div>
                                    <div class="text-sm text-gray-500">{{ alert.student_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-{{ alert.type_class }}">
                                {{ alert.type }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-{{ alert.risk_class }}">
                                {{ alert.risk_level }}
                            </span>
                        </td>
                        <td>
                            <span class="text-sm text-gray-500">{{ alert.time_ago }}</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ alert.status_class }}">
                                {{ alert.status }}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-outline" onclick="viewAlert({{ alert.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if alert.status == 'ACTIVE' %}
                                <button class="btn btn-sm btn-success" onclick="resolveAlert({{ alert.id }})">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- High Risk Students -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- High Risk Students -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">High Risk Students</h3>
                <a href="{{ url_for('main.students', risk_level='HIGH') }}" class="btn btn-outline btn-sm">
                    View All
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            <div class="space-y-4">
                {% for student in high_risk_students[:5] %}
                <div class="flex items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-red-600"></i>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ student.full_name }}</p>
                                <p class="text-sm text-gray-500">{{ student.student_id }}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-red-600">{{ student.risk_score }}</span>
                                <p class="text-xs text-red-500">Risk Score</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="flex gap-4 text-sm text-gray-600">
                                <span><i class="fas fa-calendar-alt mr-1"></i>{{ student.attendance_rate }}% Attendance</span>
                                <span><i class="fas fa-chart-line mr-1"></i>{{ student.average_score }}% Average</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Upcoming Interventions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Upcoming Interventions</h3>
                <a href="{{ url_for('main.interventions') }}" class="btn btn-outline btn-sm">
                    View All
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            <div class="space-y-4">
                {% for intervention in upcoming_interventions[:5] %}
                <div class="flex items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-hands-helping text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ intervention.title }}</p>
                                                                <p class="text-sm text-gray-500">{{ intervention.student_name }}</p>
                                                            </div>
                                                            <div class="text-right">
                                                                <span class="badge badge-{{ intervention.status_class }}">
                                                                    {{ intervention.status }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="mt-2">
                                                            <div class="flex gap-4 text-sm text-gray-600">
                                                                <span><i class="fas fa-calendar mr-1"></i>{{ intervention.scheduled_date }}</span>
                                                                <span><i class="fas fa-user mr-1"></i>{{ intervention.assigned_to }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Quick Actions</h3>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {% if current_user.role in ['ADMIN', 'TEACHER'] %}
                                            <button class="btn btn-primary w-full" onclick="showAddStudentModal()">
                                                <i class="fas fa-user-plus mr-2"></i>
                                                Add Student
                                            </button>
                                            <button class="btn btn-warning w-full" onclick="showCreateAlertModal()">
                                                <i class="fas fa-bell mr-2"></i>
                                                Create Alert
                                            </button>
                                            <button class="btn btn-success w-full" onclick="showScheduleInterventionModal()">
                                                <i class="fas fa-calendar-plus mr-2"></i>
                                                Schedule Intervention
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-secondary w-full" onclick="generateReport()">
                                                <i class="fas fa-file-alt mr-2"></i>
                                                Generate Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modals -->
                            <div id="addStudentModal" class="modal">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h3 class="text-lg font-semibold">Add New Student</h3>
                                        <button class="btn btn-secondary" onclick="closeModal('addStudentModal')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="addStudentForm">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="form-group">
                                                    <label class="form-label">First Name</label>
                                                    <input type="text" name="first_name" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Last Name</label>
                                                    <input type="text" name="last_name" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Student ID</label>
                                                    <input type="text" name="student_id" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Email</label>
                                                    <input type="email" name="email" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Phone</label>
                                                    <input type="tel" name="phone" class="form-control">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Grade</label>
                                                    <select name="grade" class="form-control form-select" required>
                                                        <option value="">Select Grade</option>
                                                        <option value="1">Grade 1</option>
                                                        <option value="2">Grade 2</option>
                                                        <option value="3">Grade 3</option>
                                                        <option value="4">Grade 4</option>
                                                        <option value="5">Grade 5</option>
                                                        <option value="6">Grade 6</option>
                                                        <option value="7">Grade 7</option>
                                                        <option value="8">Grade 8</option>
                                                        <option value="9">Grade 9</option>
                                                        <option value="10">Grade 10</option>
                                                        <option value="11">Grade 11</option>
                                                        <option value="12">Grade 12</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Section</label>
                                                    <input type="text" name="section" class="form-control">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Roll Number</label>
                                                    <input type="text" name="roll_number" class="form-control">
                                                </div>
                                                <div class="form-group md:col-span-2">
                                                    <label class="form-label">Parent/Guardian Name</label>
                                                    <input type="text" name="parent_guardian_name" class="form-control">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Parent/Guardian Phone</label>
                                                    <input type="tel" name="parent_guardian_phone" class="form-control">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Parent/Guardian Email</label>
                                                    <input type="email" name="parent_guardian_email" class="form-control">
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
                                        <button type="submit" form="addStudentForm" class="btn btn-primary">Add Student</button>
                                    </div>
                                </div>
                            </div>

                            <script>
                                // Chart configurations
                                const riskChartCtx = document.getElementById('riskChart').getContext('2d');
                                const attendanceChartCtx = document.getElementById('attendanceChart').getContext('2d');

                                // Risk Distribution Chart
                                new Chart(riskChartCtx, {
                                    type: 'doughnut',
                                    data: {
                                        labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical'],
                                        datasets: [{
                                            data: [{{ risk_distribution.low }}, {{ risk_distribution.medium }}, {{ risk_distribution.high }}, {{ risk_distribution.critical }}],
                                            backgroundColor: [
                                                '#10b981',
                                                '#f59e0b',
                                                '#ef4444',
                                                '#dc2626'
                                            ],
                                            borderWidth: 0
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                position: 'bottom'
                                            }
                                        }
                                    }
                                });

                                // Attendance Trend Chart
                                new Chart(attendanceChartCtx, {
                                    type: 'line',
                                    data: {
                                        labels: {{ attendance_trend.dates | tojson }},
                                        datasets: [{
                                            label: 'Attendance Rate',
                                            data: {{ attendance_trend.rates | tojson }},
                                            borderColor: '#4f46e5',
                                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                            tension: 0.4
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                max: 100
                                            }
                                        }
                                    }
                                });

                                // Modal functions
                                function showModal(modalId) {
                                    document.getElementById(modalId).classList.add('open');
                                }

                                function closeModal(modalId) {
                                    document.getElementById(modalId).classList.remove('open');
                                }

                                function showAddStudentModal() {
                                    showModal('addStudentModal');
                                }

                                function showCreateAlertModal() {
                                    // Implementation for create alert modal
                                    console.log('Create alert modal');
                                }

                                function showScheduleInterventionModal() {
                                    // Implementation for schedule intervention modal
                                    console.log('Schedule intervention modal');
                                }

                                function viewAlert(alertId) {
                                    // Implementation for viewing alert details
                                    console.log('View alert:', alertId);
                                }

                                function resolveAlert(alertId) {
                                    // Implementation for resolving alert
                                    fetch(`/api/alerts/${alertId}/resolve`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            resolution_notes: 'Resolved from dashboard'
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        location.reload();
                                    })
                                    .catch(error => {
                                        console.error('Error resolving alert:', error);
                                    });
                                }

                                function exportReport() {
                                    // Implementation for report export
                                    fetch('/api/analytics/export', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            type: 'dashboard',
                                            format: 'csv'
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        const blob = new Blob([data.data], { type: 'text/csv' });
                                        const url = window.URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = data.filename;
                                        a.click();
                                        window.URL.revokeObjectURL(url);
                                    })
                                    .catch(error => {
                                        console.error('Error exporting report:', error);
                                    });
                                }

                                function refreshData() {
                                    location.reload();
                                }

                                // Form submission
                                document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                                    e.preventDefault();
                                    
                                    const formData = new FormData(this);
                                    const data = Object.fromEntries(formData);
                                    
                                    fetch('/api/students', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify(data)
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        closeModal('addStudentModal');
                                        location.reload();
                                    })
                                    .catch(error => {
                                        console.error('Error adding student:', error);
                                    });
                                });

                                // Time range change handlers
                                document.getElementById('riskTimeRange').addEventListener('change', function() {
                                    updateRiskChart(this.value);
                                });

                                document.getElementById('attendanceTimeRange').addEventListener('change', function() {
                                    updateAttendanceChart(this.value);
                                });

                                function updateRiskChart(days) {
                                    // Implementation for updating risk chart based on time range
                                    console.log('Updating risk chart for', days, 'days');
                                }

                                function updateAttendanceChart(days) {
                                    // Implementation for updating attendance chart based on time range
                                    console.log('Updating attendance chart for', days, 'days');
                                }
                            </script>

                            {% block scripts %}{% endblock %}
                            {% endblock %}
